<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Notes viewer</title>

    <!-- Marked.js –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Highlight.js –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–¥–∞ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, Arial, sans-serif;
            margin: 24px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        input, select, button {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #0052a3;
        }
        #content {
            margin-top: 16px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #ffffff;
            min-height: 200px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            line-height: 1.6;
        }
        #meta {
            margin-top: 12px;
            color: #666;
            font-size: 13px;
        }
        #error {
            margin-top: 12px;
            color: #d32f2f;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
            display: none;
        }
        #error:not(:empty) {
            display: block;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è Markdown */
        #content h1 {
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            margin-top: 24px;
        }
        #content h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
            margin-top: 20px;
        }
        #content h3 {
            margin-top: 16px;
        }
        #content a {
            color: #0066cc;
            text-decoration: none;
        }
        #content a:hover {
            text-decoration: underline;
        }
        #content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        #content pre {
            background: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #e1e4e8;
        }
        #content pre code {
            background: transparent;
            padding: 0;
        }
        #content blockquote {
            margin-left: 0;
            padding-left: 16px;
            border-left: 4px solid #ddd;
            color: #666;
        }
        #content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }
        #content table th,
        #content table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        #content table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        #content ul, #content ol {
            padding-left: 24px;
        }
        #content li {
            margin: 4px 0;
        }
        #content img {
            max-width: 100%;
            height: auto;
        }
        #content hr {
            border: none;
            border-top: 2px solid #eee;
            margin: 24px 0;
        }
        #content p {
            margin: 12px 0;
        }

        .toggle-container {
            margin-top: 12px;
        }
        .toggle-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        .toggle-label input {
            cursor: pointer;
        }

        .debug-info {
            margin-top: 16px;
            padding: 12px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            color: #333;
            display: none;
            white-space: pre-wrap;
        }
        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
<h1>üìù –ó–∞–º–µ—Ç–∫–∞</h1>

<div class="row">
    <select id="mode">
        <option value="name">–ü–æ name</option>
        <option value="id">–ü–æ id</option>
    </select>

    <input id="q" size="40" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –º—ã—Å–ª—å.—á—Ç–æ-—Ç–æ –∏–ª–∏ UUID" />
    <button id="load">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>

<div class="toggle-container">
    <label class="toggle-label">
        <input type="checkbox" id="renderMarkdown" checked />
        <span>–†–µ–Ω–¥–µ—Ä–∏—Ç—å Markdown</span>
    </label>
    <label class="toggle-label" style="margin-left: 16px;">
        <input type="checkbox" id="showDebug" />
        <span>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É</span>
    </label>
</div>

<div id="meta"></div>
<div id="error"></div>
<div class="debug-info" id="debugInfo"></div>
<div id="content"></div>

<script>
    const modeEl = document.getElementById('mode');
    const qEl = document.getElementById('q');
    const metaEl = document.getElementById('meta');
    const errEl = document.getElementById('error');
    const contentEl = document.getElementById('content');
    const btn = document.getElementById('load');
    const renderMarkdownEl = document.getElementById('renderMarkdown');
    const showDebugEl = document.getElementById('showDebug');
    const debugInfoEl = document.getElementById('debugInfo');

    let currentNote = null;

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ marked.js
    marked.setOptions({
        breaks: true,
        gfm: true,
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (err) {}
            }
            return hljs.highlightAuto(code).value;
        }
    });

    function setError(msg) {
        errEl.textContent = msg || '';
    }

    function setMeta(note) {
        const name = note?.name ? `name: ${note.name}` : '';
        const id = note?.id ? `id: ${note.id}` : '';
        metaEl.textContent = [name, id].filter(Boolean).join(' | ');
    }

    function updateDebugInfo(content) {
        if (!content) {
            debugInfoEl.textContent = '–ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏';
            return;
        }

        const lines = content.split('\n');
        const info = [
            `–î–ª–∏–Ω–∞: ${content.length} —Å–∏–º–≤–æ–ª–æ–≤`,
            `–°—Ç—Ä–æ–∫: ${lines.length}`,
            `–ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤:\n${content.substring(0, 200)}`,
            `\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–∏–º–≤–æ–ª–æ–≤:\n${content.substring(Math.max(0, content.length - 100))}`
        ];

        debugInfoEl.textContent = info.join('\n');
    }

    function displayContent(content) {
        if (!content) {
            contentEl.innerHTML = '<em style="color: #999;">–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ</em>';
            updateDebugInfo('');
            return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        updateDebugInfo(content);

        if (renderMarkdownEl.checked) {
            // –†–µ–Ω–¥–µ—Ä–∏–º Markdown
            try {
                contentEl.innerHTML = marked.parse(content);
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∫–æ –≤—Å–µ–º –±–ª–æ–∫–∞–º –∫–æ–¥–∞
                contentEl.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Markdown:', e);
                // Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
                contentEl.innerHTML = `<pre style="white-space: pre-wrap; word-break: break-word; margin: 0;">${escapeHtml(content)}</pre>`;
            }
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
            contentEl.innerHTML = `<pre style="white-space: pre-wrap; word-break: break-word; margin: 0;">${escapeHtml(content)}</pre>`;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function loadNote() {
        setError('');
        metaEl.textContent = '';
        contentEl.innerHTML = '';
        debugInfoEl.textContent = '';
        currentNote = null;

        const mode = modeEl.value;
        const q = qEl.value.trim();

        if (!q) {
            setError('–ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å');
            return;
        }

        const url = mode === 'id'
            ? `/notes/${encodeURIComponent(q)}`
            : `/notes?name=${encodeURIComponent(q)}`;

        try {
            const resp = await fetch(url);
            if (!resp.ok) {
                const text = await resp.text().catch(() => '');
                throw new Error(`${resp.status} ${resp.statusText}${text ? ` ‚Äî ${text}` : ''}`);
            }

            const note = await resp.json();
            currentNote = note;

            console.log('–ü–æ–ª—É—á–µ–Ω–Ω–∞—è –∑–∞–º–µ—Ç–∫–∞:', note);
            console.log('–ö–æ–Ω—Ç–µ–Ω—Ç:', note?.content);
            console.log('–î–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:', note?.content?.length);

            setMeta(note);
            displayContent(note?.content ?? '');
        } catch (e) {
            setError(String(e.message || e));
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
        }
    }

    btn.addEventListener('click', loadNote);
    qEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') loadNote();
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    renderMarkdownEl.addEventListener('change', () => {
        if (currentNote && currentNote.content) {
            displayContent(currentNote.content);
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    showDebugEl.addEventListener('change', () => {
        if (showDebugEl.checked) {
            debugInfoEl.classList.add('show');
        } else {
            debugInfoEl.classList.remove('show');
        }
    });
</script>
</body>
</html>